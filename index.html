<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Sqlite3 Page explorer</title>
    <style>
      html, body {
        height: 100%;
        font-family: Arial, Helvetica, sans-serif
      }
      ul {
        margin: 3px;
        padding-left: 20px
      }
      li {
        cursor: hand
      }
      div {
        margin: 3px
      }
      .fancyButton {
        font-size: 24px;
        font-weight: bold;
        display: inline-block;
        margin: 0 auto;
        color: #dcfbb4;
        background-color: green;
        border: 0.2em solid #d4f7da;
        transition: all 0.3s;
        box-sizing: border-box;
        height: 2em;
        line-height: 1em;
        cursor: pointer;
        box-shadow: 0 0 0 rgba(0,0,0,0.1), inset 0 0 0 rgba(0,0,0,0.1);
        text-align: center;
      }
      .fancyButton:hover {
        box-shadow: 0 0 2em rgba(0,0,0,0.1), inset 0 0 1em rgba(0,0,0,0.1);
        background-color: #29a074;
      }
      .outlineArea {
        border-style: solid;
        border-width: 1px;
        overflow-y: scroll;
        height:95%
      }
      .detailArea {
        width: 100%; height: 95%;
        white-space: pre;
        text-overflow: clip;
        overflow: auto;
        border: 1px solid
      }
      .hexArea {
        width: 100%; height: 95%;
        white-space: pre;
        text-overflow: clip;
        overflow: auto;
        border: 1px solid;
        font-family: "Courier New", Courier, monospace
      }
      .bh {
        border: 1px solid #0000ff
      }
      .bca {
        border: 1px solid #ff0000
      }
      .bfb {
        border: 1px solid #00ff00
      }
      .bc {
        border: 1px solid #501064
      }
    </style>
  </head>

  <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
  <script>window.$ = window.jQuery = require('jquery');</script>
  <script>
    require('./renderer.js')
    const {dialog} = require('electron').remote
    const fs = require('fs');

    var myBinaryFileFD = 0;
    var pageSize, usableSize, maxLocal, minLocal, maxLeaf, minLeaf;
    var pageInfo = {hexStr: null, start: 0, ptype: 0, curPos: 0, cellarr: null, cellend: 0,
                      atype: 'h', firstFreeBlockStart: 0, cellCount: 0, nxtFB: 0};
    function oneHexByteToInt(s, pos) {
      return parseInt(s.substr(pos * 3, 2), 16);
    }
    function twoBytesToInt(b1, b2) {
      return b1 << 8 + b2;
    }
    function fourHexBytesToInt(s, pos) {
      return parseInt(s.substr(pos * 3, 2) + s.substr((pos + 1) * 3, 2) 
                + s.substr((pos + 2) * 3, 2) + s.substr((pos + 3) * 3, 2), 16);
    }
    function twoHexBytesToInt(s, pos) {
      return parseInt(s.substr(pos * 3, 2) + s.substr((pos + 1) * 3, 2), 16);
    }
    function getIntValue(s, pos, sz) {
      var ret = 0;
      for (var i = 0; i < sz; i++) {
        ret <<= 8;
        ret += oneHexByteToInt(s, pos + i);
      }
      return ret;
    }
    function getFloatValue(s, pos) {
      var buffer = new ArrayBuffer(8);
      for (var i = 0; i < 8; i++) {
        buffer[i] = oneHexByteToInt(s, pos + i);
      }
      var dv = new DataView(buffer);
      return dv.getFloat64(0, false);
    }
    function getVarInt(s, pos) {
      var ret = [0, 0];
      while (ret[1]++ < 8) {
        ret[0] <<= 7;
        b = oneHexByteToInt(s, pos);
        ret[0] += b & 0x7F;
        if ((b >> 7) == 0)
            return ret;
        pos++;
      }
      ret[1]++;
      ret[0] <<= 8;
      ret[0] += oneHexByteToInt(s, pos);
      return ret;
    }
    function getHexFromNibble(nibble) {
      if (nibble < 10)
          return String.fromCharCode(48 + nibble);
      else
          return String.fromCharCode(97 + nibble - 10);
    }
    function hexFromByte(b) {
      return getHexFromNibble(b >> 4) + getHexFromNibble(b & 0x0F);
    }
    function toHexString(buf) {
      var s = "";
      for (var i = 0; i < buf.length; i++) {
        if (i != 0)
          s += " ";
        s += hexFromByte(buf[i]);
      }
      return s;
    }
    function markDumpStart() {
      if (pageInfo.ptype == 0)
        return "";
      if (pageInfo.curPos == pageInfo.start * 3)
        return "<span class='bh'>";
      var hdrSize = (pageInfo.ptype == 2 || pageInfo.ptype == 5) ? 12 : 8;
      if ((pageInfo.curPos - pageInfo.start * 3) == hdrSize * 3 && pageInfo.cellCount > 0) {
        pageInfo.cellarr = new Array();
        for (var i = 0; i < pageInfo.cellCount; i++)
          pageInfo.cellarr[pageInfo.cellarr.length] = twoHexBytesToInt(pageInfo.hexStr, i * 2 + pageInfo.curPos / 3);
        pageInfo.cellarr.sort();
        return "<span class='bca'>";
      }
      if (pageInfo.nxtFB > 0 && pageInfo.curPos == (pageInfo.start + pageInfo.nxtFB) * 3)
        return "<span class='bfb'>";
      if (pageInfo.cellarr != null && pageInfo.cellarr.length > 0 && pageInfo.cellarr[0] == pageInfo.curPos / 3) {
        if (pageInfo.ptype == 5)
          pageInfo.cellend = 3 * (pageInfo.cellarr[0] + 4 + getVarInt(pageInfo.hexStr, pageInfo.cellarr[0] + 4)[1]);
        else {
          var vInt = getVarInt(pageInfo.hexStr, pageInfo.cellarr[0] + (pageInfo.ptype == 2 ? 4 : 0));
          if (pageInfo.ptype == 13) {
            pageInfo.cellend = 3 * (pageInfo.cellarr[0] + vInt[1] + vInt[0] 
              + getVarInt(pageInfo.hexStr, pageInfo.cellarr[0] + vInt[1])[1]);
          } else {
            pageInfo.cellend = 3 * (pageInfo.cellarr[0] + (pageInfo.ptype == 2 ? 4 : 0) + vInt[1] + vInt[0]);
          }
        }
        pageInfo.cellarr.shift();
        return "<span class='bc'>";
      }
      return "";
    }
    const spanend = "</span>";
    const brk = "<br>";
    function markDumpEnd() {
      if (pageInfo.ptype == 0)
        return "";
      var hdrEnd = (pageInfo.ptype == 2 || pageInfo.ptype == 5) ? 11 : 7;
      if ((pageInfo.curPos - pageInfo.start * 3) == (hdrEnd * 3))
        return spanend;
      if ((pageInfo.curPos - pageInfo.start * 3) == (hdrEnd + pageInfo.cellCount * 2) * 3)
        return spanend;
      if (pageInfo.nxtFB > 0 && pageInfo.curPos == (pageInfo.start + pageInfo.nxtFB + 4) * 3) {
        pageInfo.nxtFB = twoHexBytesToInt(pageInfo.hexStr, start + pageInfo.nxtFB + 2);
        return spanend;
      }
      if (pageInfo.cellend > 0 && pageInfo.curPos == pageInfo.cellend) {
        pageInfo.cellend = 0;
        return spanend;
      }
      return "";
    }
    function showHex(s, start, ptype) {
      pageInfo.hexStr = s;
      pageInfo.start = start;
      pageInfo.ptype = ptype;
      pageInfo.atype = 'h';
      pageInfo.cellarr = null;
      pageInfo.cellend = 0;
      pageInfo.cellCount = twoHexBytesToInt(s, start + 3);
      pageInfo.nxtFB = pageInfo.firstFreeBlockStart;
      pageInfo.firstFreeBlockStart = twoHexBytesToInt(s, start + 1);
      var hex = "";
      var dec = "";
      var txt = "";
      for (var i = 0; i < s.length; i += 3) {
        if (i > 0 && i % 48 == 0) {
          hex += brk;
          dec += brk;
          txt += brk;
        }
        pageInfo.curPos = i;
        var st = markDumpStart();
        hex += st; dec += st; txt += st;
        hex += s.substr(i, 3);
        var d = parseInt(s.substr(i, 2), 16);
        dec += (d > 99 ? "" : (d > 9 ? " " : "  "));
        dec += d;
        dec += " ";
        if (d >= 32 && d <= 126)
            txt += String.fromCharCode(d);
        else
            txt += ".";
        var end = markDumpEnd();
        hex += end; dec += end; txt += end;
      }
      $('#hexArea1').empty().append(hex);
      $('#hexArea2').empty().append(dec);
      $('#hexArea3').empty().append(txt);
    }
    function openPage(parentPageId, pageNo, typ, isRoot) {
      typName = (typ == 'b' ? "BTree" : (type == 'l' ? "LockByte" 
          : (type == 'ft' ? "FreeTrunk" : (type == 'fl' ? "FreeLeaf" 
          : (type == 'o' ? "Overflow" : "PtrMap")))));
      try {
        var buffer = new Uint8Array(pageSize);
        bytesRead = fs.readSync(myBinaryFileFD, buffer, 0, pageSize, (pageNo - 1) * pageSize);
        if (bytesRead == 0) {
          alert("Unable to read page from file");
          return;
        }
        if (bytesRead < pageSize) {
          alert("Short read");
          return;
        }
        if (parentPageId == '') {
          var pageId = typ + pageNo;
          if (document.getElementById(pageId) == null) {
            $('#mainOutline').append('<li id="' + pageId 
              + '" onclick="show' + typName + 'Page(this, event, 0)">' + typName + ' page ' + pageNo 
              + '<input type="hidden" value="' + toHexString(buffer) + '"/><ul></ul></li>');
          } else
            alert("Already open");
        } else {
          var pageId = (isRoot ? "p" + parentPageId.substring(1) : parentPageId) + '_' + typ + pageNo;
          if (document.getElementById(pageId) == null) {
            $('#' + parentPageId).children("ul").append('<li id="' + pageId
              + '" onclick="show' + typName + 'Page(this, event, 0)">' + typName + ' page ' + pageNo 
              + '<input type="hidden" value="' + toHexString(buffer) + '"/><ul></ul></li>');
          } else
            alert("Already open");
        }
      } catch (err) {
          alert(err);
          window.close();
      }
    }
    function showHeader(obj) {
      var s = obj.children.item(0).value;
      showHex(s, 100, 13);
      var det = "";
      det = "<b><u>File header</u></b><br><br>Header string: <b>SQLite format 3</b>";
      det += "<br>Page Size: <b>" + pageSize + "</b>";
      det += "<br>File format write version: <b>" + (oneHexByteToInt(s, 18) == 1 ? "Legacy" : "WAL") + "</b>";
      det += "<br>File format read version: <b>" + (oneHexByteToInt(s, 19) == 1 ? "Legacy" : "WAL") + "</b>";
      det += "<br>Bytes of unused reserved space at the end of each page: <b>" + oneHexByteToInt(s, 20) + "</b>";
      det += "<br>Maximum embedded payload fraction. Must be 64: <b>" + oneHexByteToInt(s, 21) + "</b>";
      det += "<br>Minimum embedded payload fraction. Must be 32: <b>" + oneHexByteToInt(s, 22) + "</b>";
      det += "<br>Leaf payload fraction. Must be 32: <b>" + oneHexByteToInt(s, 23) + "</b>";
      det += "<br>File change counter: <b>" + fourHexBytesToInt(s, 24) + "</b>";
      det += "<br>Size of the database file in pages: <b>" + fourHexBytesToInt(s, 28) + "</b>";
      det += "<br>Page number of the first freelist trunk page: <b>" + fourHexBytesToInt(s, 32) + "</b>";
      det += "<br>Total number of freelist pages: <b>" + fourHexBytesToInt(s, 36) + "</b>";
      det += "<br>The schema cookie: <b>" + fourHexBytesToInt(s, 40) + "</b>";
      det += "<br>The schema format number (Supported are 1, 2, 3, and 4): <b>" + fourHexBytesToInt(s, 44) + "</b>";
      det += "<br>Default page cache size: <b>" + fourHexBytesToInt(s, 48) + "</b>";
      det += "<br>Largest root b-tree page no. (in auto-vacuum or incremental-vacuum modes, else 0): <b>" + fourHexBytesToInt(s, 52) + "</b>";
      det += "<br>The database text encoding (1-UTF-8, 2-UTF-16le, 3-UTF-16be): <b>" + fourHexBytesToInt(s, 56) + "</b>";
      det += "<br>The 'user version' as read and set by the user_version pragma.: <b>" + fourHexBytesToInt(s, 60) + "</b>";
      det += "<br>Incremental-vacuum mode (0-true, 1-false): <b>" + fourHexBytesToInt(s, 64) + "</b>";
      det += "<br>The 'Application ID' set by PRAGMA application_id: <b>" + fourHexBytesToInt(s, 68) + "</b>";
      det += "<br>The version-valid-for number: <b>" + fourHexBytesToInt(s, 92) + "</b>";
      det += "<br>SQLITE_VERSION_NUMBER: <b>" + fourHexBytesToInt(s, 96) + "</b>";
      det += "<br><br>";
      $('#detailArea').empty().append(det);
    }
    function showBTreePage(obj, evt, start) {
      var s = obj.children.item(0).value;
      det = "<b><u>Page contents</u></b><br>";
      var ptype, ptypestr;
      ptype = oneHexByteToInt(s, start);
      showHex(s, start, ptype);
      ptypestr = (ptype == 2 ? "Interior index" : (ptype == 5 ? "Interior table" : (ptype == 10 ? "Leaf index" : ptype == 13 ? "Leaf table" : "Invalid")));
      det += "<br>Page type (2-interior index, 5-interior table, 10-leaf index, 13-leaf table): <b>" + ptypestr + "</b>";
      det += "<br>First freeblock on the page: <b>" + twoHexBytesToInt(s, start + 1) + "</b>";
      var cellCount = twoHexBytesToInt(s, start + 3);
      det += "<br>Number of cells on page: <b>" + cellCount + "</b>";
      det += "<br>Start of cell content area: <b>" + twoHexBytesToInt(s, start + 5) + "</b>";
      det += "<br>Number of fragmented free bytes: <b>" + oneHexByteToInt(s, start + 7) + "</b>";
      var pageId = obj.id;
      var hdrSize = 8;
      if (ptype == 2 || ptype == 5) {
        var rightPtr = fourHexBytesToInt(s, start + 8);
        det += "<br>Right most pointer: <b>" + rightPtr + "</b>&nbsp;<input type='button' value='Open' onclick='openPage(\"" + pageId + "\"," + rightPtr + ", \"b\", false)'/>";
        hdrSize = 12;
      }
      det += "<br><b>Cells:</b><br/>";
      det += "<table cellspacing='1' cellpadding='1' border='1'>";
      det += "<thead><td>Page</td><td>Row ID</td><td>Len</td><td>Payload</td><td>Overflow</td></thead>";
      for (var cell = 0; cell < cellCount; cell++) {
        var cellPtr = twoHexBytesToInt(s, cell * 2 + hdrSize + start);
        det += "<tr>";
        if (ptype == 2 || ptype == 5) {
          var pageNo = fourHexBytesToInt(s, cellPtr);
          det += "<td><input type='button' value='Page " + pageNo + "' onclick='openPage(\"" + pageId + "\"," 
                  + pageNo + ", \"b\", false)'/></td>";
          cellPtr += 4;
        }
        var vInt = getVarInt(s, cellPtr);
        cellPtr += vInt[1];
        switch (ptype) {
          case 2:
            det += "<td>-</td><td>" + vInt[0] + "</td>";
            break;
          case 5:
            det += "<td>" + vInt[0] + "</td><td>-</td><td>-</td><td>-</td>";
            break;
          case 10:
            det += "<td>-</td><td>-</td><td>" + vInt[0] + "</td>";
            break;
          case 13:
            var vInt1 = getVarInt(s, cellPtr);
            det += "<td>-</td><td>" + vInt1[0] + "</td>";
            det += "<td>" + vInt[0] + "</td>";
            cellPtr += vInt1[1];
            break;
        }
        if (ptype == 2 || ptype == 10 || ptype == 13) {
          var hdrInfo = getVarInt(s, cellPtr);
          if (vInt[0] <= (ptype == 13 ? maxLeaf : maxLocal)) {
            var hdrLen = hdrInfo[0] - hdrInfo[1];
            var dataPtr = cellPtr + hdrInfo[0];
            cellPtr += hdrInfo[1];
            var hdr = "";
            var colIdx = 0;
            for (var i = 0; i < hdrLen; ) {
              var colInfo = getVarInt(s, cellPtr);
              det += "<td>";
              switch (colInfo[0]) {
                case 0:
                case 8:
                case 9:
                  hdr += "<td>-</td>";
                  det += (colInfo[0] == 0 ? "null" : (colInfo[0] == 8 ? "0" : "1"));
                  break;
                case 1:
                case 2:
                case 3:
                case 4:
                  hdr += "<td>i" + (8 * colInfo[0]) + "</td>";
                  det += getIntValue(s, dataPtr, colInfo[0]);
                  dataPtr += colInfo[0];
                  break;
                case 5:
                case 6:
                  hdr += "<td>i" + (colInfo[0] == 5 ? "48" : "64") + "</td>";
                  det += getIntValue(s, dataPtr, colInfo[0] == 5 ? 6 : 8);
                  dataPtr += colInfo;
                  break;
                case 7:
                  hdr += "<td>f64</td>";
                  det += getFloatValue(s, dataPtr);
                  dataPtr += colInfo[0];
                  break;
                case 10:
                case 11:
                  hdr += "?";
                  det += "?";
                  break;
                default:
                  var dataLen = colInfo[0] - (colInfo[0] % 2 ? 12 : 13);
                  dataLen /= 2;
                  dataLen = Math.floor(dataLen);
                  if (colInfo[0] % 2) {
                    hdr += "<td>text</td>";
                    var str = "";
                    for (var j = 0; j < dataLen; j++)
                      str += String.fromCharCode(oneHexByteToInt(s, dataPtr + j));
                    det += unescape(str);
                  } else {
                    hdr += "<td>blob</td>";
                    det += s.substr(dataPtr * 3, dataLen * 3);
                  }
                  dataPtr += dataLen;
              }
              if (pageId.substr(0, 2) == 'r0' && colIdx == 3) {
                var pageNo = det.substring(det.lastIndexOf("<td>") + 4);
                det += "<input type='button' value='Open'"
                       + " onclick='openPage(\"" + pageId + "\"," + pageNo + ", \"b\", true)'/>";
              }
              det += "</td>";
              i += colInfo[1];
              cellPtr += colInfo[1];
              colIdx++;
            }
            var toFind = "<td>Payload</td>";
            var idx = det.indexOf(toFind);
            if (idx != -1)
              det = det.substring(0, idx) + hdr + det.substring(idx + toFind.length);
            det += "<td></td>";
          } else {
            vInt[0] -= 4;
            var pageNo = fourHexBytesToInt(s, cellPtr + vInt[0]);
            det += "<td>" + s.substr(cellPtr * 3, vInt[0] * 3) + "</td>";
            det += "<td><input type='button' value='Page " + pageNo + "' onclick='openPage(\"" + pageId + "\"," 
                    + pageNo + ", \"o\", false)'/></td>";
          }
        }
        det += "</tr>";
      }
      det += "</table>";
      $('#detailArea').empty().append(det);
      evt.stopPropagation();
    }
    function showPage1(obj, evt) {
      showBTreePage(obj, evt, 100);
    }
    function selectFile() {
      try {
        dialog.showOpenDialog(function (fileNames) {
            if (fileNames === undefined) {
              alert("No file selected");
            } else {
              if (myBinaryFileFD != 0) {
                  fs.close(myBinaryFileFD, (err) => {
                    if (err) throw err;
                    myBinaryFileFD = 0;
                  });
              }
              $('#dbName').empty().append(fileNames[0]);
              fs.open(fileNames[0], 'r', (err, fd) => {
                myBinaryFileFD = fd;
                if (err) throw err;
                var buffer = new Uint8Array(100);
                var bytesRead = fs.readSync(fd, buffer, 0, 100, 0);
                if (buffer[0] != 83 || buffer[1] != 81 || buffer[2] != 76 || buffer[3] != 105
                       || buffer[4] != 116 || buffer[5] != 101 || buffer[6] != 32 || buffer[7] != 102
                       || buffer[8] != 111 || buffer[9] != 114 || buffer[10] != 109 || buffer[11] != 97
                       || buffer[12] != 116 || buffer[13] != 32 || buffer[14] != 51 || buffer[15] != 0) {
                    alert("Selected file is not SQLite database");
                    return;
                }
                $('#mainOutline').empty().append('<li onclick="showHeader(this)">Header<input type="hidden" value="' + toHexString(buffer) + '"/></li>');
                $('#detailArea').empty();
                $('#hexArea1').empty();
                $('#hexArea2').empty();
                $('#hexArea3').empty();
                pageSize = twoBytesToInt(buffer[16], buffer[17]);
                if (pageSize == 1)
                    pageSize = 65536;
                usableSize = pageSize - buffer[20];
                maxLocal = (usableSize-12)*64/255 - 23;
                minLocal = (usableSize-12)*32/255 - 23;
                maxLeaf = usableSize - 35;
                minLeaf = (usableSize-12)*32/255 - 23;
                buffer = new Uint8Array(pageSize);
                bytesRead = fs.readSync(fd, buffer, 0, pageSize, 0);
                $('#mainOutline').append('<li id="r0" onclick="showPage1(this, event)">Page 1<input type="hidden" value="' + toHexString(buffer) + '"/><ul></ul></li>');
                var notification = new Notification('Database loaded', {
                  body: 'DB Loaded. Double click on Header or Pages to show details',
                  title: "Loaded"
                });
              });
            }
        }); 
      } catch (err) {
          alert(err);
          window.close();
      }
    }
    function syncScroll(obj) {
      var other1 = document.getElementById(obj.id == "hexArea1" ? "hexArea2" : "hexArea1");
      var other2 = document.getElementById(obj.id == "hexArea3" ? "hexArea2" : "hexArea3");
      other1.scrollTop = obj.scrollTop;
      other2.scrollTop = obj.scrollTop;
    }
  </script>
  <script>if (window.module) module = window.module;</script>

  <body>
    <table width="100%"><tr>
      <td><img src="res/img/siara_cc_3d.png" width="72px" height="42px"></img></td>
      <td align="left" style="color: green"><h1>Sqlite3 Page explorer</h1></td>
      <td style="text-align: right" ><input type="button" class="fancyButton" onclick="selectFile();" value="Open database"/></td>
    </tr></table>
    <table width="100%" height="40%" style="table-layout:fixed;">
      <tr>
          <td width="35%">Outline:</td>
          <td width="65%">Page details:</td>
      </tr>
      <tr height="98%">
          <td width="35%">
            <ul class="outlineArea" id="mainOutline"></ul>
          </td>
          <td width="65%">
            <div class="detailArea" id="detailArea"></div>
          </td>
      </tr>
    </table>
    <table width="100%" height="35%" style="table-layout:fixed;">
      <tr>
        <td width="38%">Hex view:</td>
        <td width="44%">Decimal view:</td>
        <td width="18%">Text view:</td>
      </tr>
      <tr height="98%">
        <td width="38%">
          <div class="hexArea" id="hexArea1" onscroll="syncScroll(this);"></div>
        </td>
        <td width="44%">
          <div class="hexArea" id="hexArea2" onscroll="syncScroll(this);"></div>
        </td>
        <td width="18%">
          <div class="hexArea" id="hexArea3" onscroll="syncScroll(this);"></div>
        </td>
      </tr>
    </table>
    <table width="100%"><tr>
      <td id="dbName"></td>
      <td style="text-align: right" >
        <a href="https://www.sqlite.org/fileformat.html">&lt;Ref&gt;</a>
        &nbsp;
        <a href="http://siara.cc">&copy;&nbsp;Siara Logics (cc) 2015-18</a>
        &nbsp;
        <a href="https://github.com/siara-cc/sqlite3_page_dissector">GitHub</a>
      </td>
    </tr></table>
  </body>

</html>
